<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<style type="text/css">
			body,
			html,
			#allmap {
				width: 100%;
				height: 100%;
				overflow: auto;
				margin: 0;
				font-family: "微软雅黑";
				background: #eee;
			}

			#allmap {
				width: 100%;
				height: 100vh;
			}

			.xc-group {
				margin-bottom: 10px;
				background: #fff;
			}

			.xc-group>div>div {
				padding: 2px;
			}

			/*.sun-left .sun .sun-left > div:first-child {
      border-bottom: solid 1px #eee;
    }*/
			.sun {
				display: inline-block;
				vertical-align: top;
				width: calc(100% - 70px);
				border-right: solid 1px #eee;
			}

			.xc-group .sun>div:first-child {
				border-bottom: solid 1px #eee;
			}

			.sub-right {
				display: inline-block;
				vertical-align: top;
				width: 60px;
				text-align: center;
				padding-top: 10px;
				/* position: relative;top:-10px; */
			}
			.xc-day {
				display: inline-block;
				vertical-align: top;
				height: 42px;
				width:42px;
				line-height: 42px;
				text-align: center;
				/* padding: 4px; */
			}
			.xc-day-select {
				color:rgb(64, 158, 255);
			}
		</style>
		<script type="text/javascript"
			src="http://api.map.baidu.com/api?type=webgl&v=1.0&ak=48Roq20p72HfZGhxnKm3BPE8mK4ZCtzc"></script>
		<script type="text/javascript" src="http://api.map.baidu.com/library/LuShu/gl/src/LuShu_min.js"></script>
		<!-- <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script> -->
		<link href="./lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
		<!-- <script src="./lib/jquery/jquery-1.3.2.min.js" type="text/javascript"></script> -->
		<script src="./lib/ligerUI/js/core/base.js" type="text/javascript"></script>
		<script src="./lib/ligerUI/js/ligerui.all.js" type="text/javascript"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<title>车辆行程</title>
	</head>

	<body>
		<div id="allmap">
			<div style="padding: 4px 16px 0 16px;position: relative;height: 32px;border-bottom: solid 1px #DDd;">
				<span style="position: relative;top:4px;">IMEI:{{imei}}</span>
				<div
					style="display: inline-block;vertical-align: top;position: absolute;right: 16px;background: #409eff;color: #fff;padding: 2px 8px;border-radius: 2px;">
					<img src="http://daka.xixiaoli.com/webgl/img/trunk.png"
						style="width:20px;height:20px;padding-right: 8px;display: inline-block;vertical-align: text-bottom;" />
					<span>{{deviceName}}</span>
				</div>
			</div>
			<div style="padding:8px 16px;">
				<div>
					<!-- 请选择日期：<input class="xc-now" type="date" style="display: inline-block;" /> -->
					<div style="text-align: center;display: inline-block;padding: 4px;">
						{{year}}年<br>
						{{month}}月
					</div>
					<div style="overflow: auto;display: inline-block;vertical-align: top;width: calc(100% - 52px);">
						<div  :style="{width:iwidth}">
							<div v-for="(item,index) in days" :class="{'xc-day':true,'xc-day-select':item.select}" :key="index" @click="handleDay(item,index)">
								{{item.val}}
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div>
				<div v-for="(item,index) in rows" style="padding: 8px" :key="index">
					<div v-for="(sub,sindex) in item" :key="sindex" class="xc-group">
						<div class="sun">
							<div v-for="(sun,sunindex) in sub" :key="sunindex">
								<img :src="handleImg(sunindex)"
									style="width:20px;height:20px;display: inline-block;vertical-align: top;    margin: 6px;" />
								<div style="display: inline-block;vertical-align: top;">
									<div style="color:#409eff">
										<span>{{sun.gpsTime}}</span>
										<label>{{sunindex == 0?'起点':'终点'}}</label>
									</div>
									<div>{{sun.locationName}}</div>
								</div>
							</div>
						</div>
						<div class="sub-right" style="">
							<img src="http://daka.xixiaoli.com/webgl/img/distance.png"
								style="width:30x;height:30px;display: block;margin:0 auto;" />
							{{sub.disKm}}
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="tmpMap" style="height:1px;width:1px;">

		</div>
	</body>

</html>
<script type="text/javascript">
	var now = getNowFormatDate();
	console.log('now', now, $('.xc-now'))
	$('.xc-now').attr('value', now);


	var app = new Vue({
		el: '#allmap',
		data: {
			message: '行程数据',
			rows: [],
			locationNames: [],
			imei: '',
			deviceName: '',
			year:'2021',
			month:'7',
			day:'1',
			days:[],
			iwidth:''
		},
		created() {
			var that = this;
			this.main();
			// $('.xc-now').on('input', function(e) {
			// 	var changeValue = $(e.currentTarget).val();
			// 	$('.xc-now').attr('value', changeValue);
			// 	// debugger
			// 	that.main(changeValue)
			// });
			this.imei = window.location.href.split('imei=')[1].split('&deviceName=')[0];
			this.deviceName = decodeURI(window.location.href.split('imei=')[1].split('&deviceName=')[1])
			this.getDaysArr()
		},
		mounted() {
			
		},
		methods: {
			handleDay(item,index){
				this.days.forEach(sub=>{
					if(sub.val == item.val){
						sub.select = true
					}else {
						sub.select = false
					}
				});
				let timeStr = this.year +'-'+ (this.month<=9?'0'+this.month:this.month)+'-'+(item.val<=9?'0'+item.val:item.val)
				this.main(timeStr)
			},
			getDaysArr(){
				this.year = new Date().getFullYear()
				this.month = new Date().getMonth()+1
				this.day = new Date().getDate()
				// this.days 
				let length = new Date(this.year, this.month, 0).getDate();
				for (var i = length ; i>0 ; i--) {
					let obj = {
						val:i,
						select:this.day == i ?true:false
					}
					this.days.push(obj)
				}
				this.iwidth = 42 * (length) + 'px'
			},
			handleImg(num) {
				if (num == 0) {
					return 'http://daka.xixiaoli.com/webgl/img/start.png'
				} else {
					return 'http://daka.xixiaoli.com/webgl/img/end.png'
				}
			},
			main(time) {
				var that = this;
				if (sessionStorage.getItem('__user_session')) {
					let param = {
						startTime: time ? time + ' 00:00:00': now + ' 00:00:00',
						endTime: time ? time + ' 23:59:59': now + ' 23:59:59',
						imei: this.imei
					};
					that.initXC(param)
				} else {
					$.ajax({
						url: "http://www.huatiexft.com:8070/eqplapp2/login.do",
						type: 'post',
						dataType: 'json',
						contentType: 'application/json',
						data: JSON.stringify({
							"user_code": "陈李强辉",
							"password": 123456,
							"loginType": "20"
						}),
						xhrFields: {
							withCredentials: true //允许跨域带Cookie
						},
						success: function(data) {
							// ?__user_session=738CB5F330B7F0A538A22F8CD30977A6
							sessionStorage.setItem('__user_session', data.success)
							sessionStorage.setItem('_userInfo', JSON.stringify(data))
							let param = {
								startTime: time ? time +' 00:00:00' : now + ' 00:00:00',
								endTime: time ? time + ' 23:59:59': now + ' 23:59:59',
								imei: imei
							};
							that.initXC(param)
							// initPosition()
						}
					});
				}

			},
			initXC(param) {
				var that = this;
				$.ajax({
					url: "http://www.huatiexft.com:8070/eqplapp2/jimiCar/getTravel.do?imei=" + param.imei +
						"&startTime=" + param.startTime + "&endTime=" + param.endTime +
						"&__user_session=" + sessionStorage.getItem('__user_session'),
					type: 'get',
					contentType: 'application/json',
					data: {},
					xhrFields: {
						withCredentials: true
					},
					success: function(data) {
						if (data) {
							try {
								let tmpdata = data;
								// let tmpdata = JSON.parse(data);
								console.log('tmpdata', tmpdata)
								tmpdata.data.forEach(item => {
									item.forEach(sub => {
										that.getLocationName(sub)
									})
									var map = new BMapGL.Map('tmpMap');
									// map.getDistance(point1 ,point2);
									var pointA = new BMapGL.Point(item[0].lng, item[0]
									.lat); // 创建点坐标A
									var pointB = new BMapGL.Point(item[1].lng, item[1].lat);
									var distance = map.getDistance(pointA, pointB);
									var disKm = (distance / 1000).toFixed(2) + "km";
									console.log('disKm', disKm)
									item.disKm = disKm
								});
								setTimeout(() => {
									that.rows = tmpdata
								}, 500)

								// initXCrows(tmpdata)
							} catch (err) {
								// let tmpdata = {
								// 	"data": [
								// 		[{
								// 				"lng": "120.16225602167883",
								// 				"lat": "32.48772934396526",
								// 				"gpsTime": "2021-07-14 10:22:00",
								// 				"gpsSpeed": "11.0",
								// 				"posType": "1",
								// 				"direction": "192",
								// 				"mileage": "0.0"
								// 			},
								// 			{
								// 				"lng": "120.06209358623599",
								// 				"lat": "32.17972514773968",
								// 				"gpsTime": "2021-07-14 11:18:22",
								// 				"gpsSpeed": "0.0",
								// 				"posType": "1",
								// 				"direction": "53",
								// 				"mileage": "0.0"
								// 			}
								// 		],
								// 		[{
								// 				"lng": "120.0620770047385",
								// 				"lat": "32.18028220969862",
								// 				"gpsTime": "2021-07-14 11:23:22",
								// 				"gpsSpeed": "7.0",
								// 				"posType": "1",
								// 				"direction": "347",
								// 				"mileage": "0.0"
								// 			},
								// 			{
								// 				"lng": "120.1155193236153",
								// 				"lat": "32.20135732540087",
								// 				"gpsTime": "2021-07-14 11:42:23",
								// 				"gpsSpeed": "0.0",
								// 				"posType": "1",
								// 				"direction": "81",
								// 				"mileage": "0.0"
								// 			}
								// 		],
								// 		[{
								// 				"lng": "120.11654631300081",
								// 				"lat": "32.201740033534534",
								// 				"gpsTime": "2021-07-14 11:47:56",
								// 				"gpsSpeed": "24.0",
								// 				"posType": "1",
								// 				"direction": "69",
								// 				"mileage": "0.0"
								// 			},
								// 			{
								// 				"lng": "120.11556338055352",
								// 				"lat": "32.4499188042568",
								// 				"gpsTime": "2021-07-14 12:20:13",
								// 				"gpsSpeed": "0.0",
								// 				"posType": "1",
								// 				"direction": "258",
								// 				"mileage": "0.0"
								// 			}
								// 		],
								// 		[{
								// 				"lng": "120.11497979676571",
								// 				"lat": "32.449763856207355",
								// 				"gpsTime": "2021-07-14 12:26:33",
								// 				"gpsSpeed": "9.0",
								// 				"posType": "1",
								// 				"direction": "247",
								// 				"mileage": "0.0"
								// 			},
								// 			{
								// 				"lng": "120.17041168456045",
								// 				"lat": "32.5236604649924",
								// 				"gpsTime": "2021-07-14 12:54:03",
								// 				"gpsSpeed": "2.0",
								// 				"posType": "1",
								// 				"direction": "181",
								// 				"mileage": "0.0"
								// 			}
								// 		],
								// 		[{
								// 				"lng": "120.17018072798868",
								// 				"lat": "32.52387826422413",
								// 				"gpsTime": "2021-07-14 14:52:23",
								// 				"gpsSpeed": "0.0",
								// 				"posType": "1",
								// 				"direction": "33",
								// 				"mileage": "0.0"
								// 			},
								// 			{
								// 				"lng": "120.17067013874997",
								// 				"lat": "32.52388549916739",
								// 				"gpsTime": "2021-07-14 15:05:45",
								// 				"gpsSpeed": "0.0",
								// 				"posType": "1",
								// 				"direction": "124",
								// 				"mileage": "0.0"
								// 			}
								// 		]
								// 	]
								// }
								// console.log('error', err)
								// tmpdata.data.forEach(item => {
								// 	item.forEach(sub => {
								// 		that.getLocationName(sub)
								// 	})
								// 	var map = new BMapGL.Map('tmpMap');
								// 	// map.getDistance(point1 ,point2);
								// 	var pointA = new BMapGL.Point(item[0].lng, item[0]
								// 	.lat); // 创建点坐标A
								// 	var pointB = new BMapGL.Point(item[1].lng, item[1].lat);
								// 	var distance = map.getDistance(pointA, pointB);
								// 	var disKm = (distance / 1000).toFixed(2) + "km";
								// 	console.log('disKm', disKm)
								// 	item.disKm = disKm
								// });
								// setTimeout(() => {
								// 	that.rows = tmpdata
								// }, 500)
								$.ligerDialog.error('暂无数据')
							}
						} else {
							$.ligerDialog.error('暂无数据')
						}
					}
				});
			},
			initXCrows(row) {

			},
			getLocationName(param) {
				var that = this;
				var geoc = new BMapGL.Geocoder();
				let pt = new BMapGL.Point(param.lng, param.lat)
				// let pt = {
				//   lng:param.lng,
				//   lat:param.lat
				// };
				geoc.getLocation(pt, function(rs) {
					var addComp = rs.addressComponents;
					param.locationName = addComp.province + addComp.city + addComp.district + addComp
						.street + addComp.streetNumber;
					that.locationNames.push(addComp.province + addComp.city + addComp.district + addComp
						.street + addComp.streetNumber);
				})
			}
		}
	})


	function getNowFormatDate() {
		var date = new Date();
		var seperator1 = "-";
		var year = date.getFullYear();
		var month = date.getMonth() + 1;
		var strDate = date.getDate();
		if (month >= 1 && month <= 9) {
			month = "0" + month;
		}
		if (strDate >= 0 && strDate <= 9) {
			strDate = "0" + strDate;
		}
		var currentdate = year + seperator1 + month + seperator1 + strDate;
		return currentdate;
	}
</script>
